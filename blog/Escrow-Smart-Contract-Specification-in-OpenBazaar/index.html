<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="google-site-verification" content="zI3sAn6GTCII6X2rmUMR1uHZG5crfyuVmzRoaqXmDq4" /><!-- Begin Jekyll SEO tag v2.5.0 -->
<title>Escrow Smart Contract Specification in OpenBazaar | OpenBazaar</title>
<meta name="generator" content="Jekyll v3.8.5" />
<meta property="og:title" content="Escrow Smart Contract Specification in OpenBazaar" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="By Austin Williams, OpenBazaar Researcher" />
<meta property="og:description" content="By Austin Williams, OpenBazaar Researcher" />
<link rel="canonical" href="https://openbazaar.org/blog/Escrow-Smart-Contract-Specification-in-OpenBazaar/" />
<meta property="og:url" content="https://openbazaar.org/blog/Escrow-Smart-Contract-Specification-in-OpenBazaar/" />
<meta property="og:site_name" content="OpenBazaar" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2018-10-24T14:30:00+00:00" />
<script type="application/ld+json">
{"description":"By Austin Williams, OpenBazaar Researcher","@type":"BlogPosting","url":"https://openbazaar.org/blog/Escrow-Smart-Contract-Specification-in-OpenBazaar/","headline":"Escrow Smart Contract Specification in OpenBazaar","dateModified":"2018-10-24T14:30:00+00:00","datePublished":"2018-10-24T14:30:00+00:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://openbazaar.org/blog/Escrow-Smart-Contract-Specification-in-OpenBazaar/"},"@context":"http://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="shortcut icon" type="image/png" href="/favicon.png">
  <link href="https://fonts.googleapis.com/css?family=Noto+Sans" rel="stylesheet">
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.0.13/css/all.css" integrity="sha384-DNOHZ68U8hZfKXOrtjWvjxusGo9WQnrNx2sqG0tfsghAvtVlRW3tvkXWZh58N9jp" crossorigin="anonymous">
  <link rel="stylesheet" href="/assets/main.css">
  
    <meta property="og:image" content="https://openbazaar.org/blog/">
    <meta property="og:title" content="Escrow Smart Contract Specification in OpenBazaar">
    <meta property="og:description" content="Escrow Smart Contract Specification in OpenBazaar">
  <link type="application/atom+xml" rel="alternate" href="https://openbazaar.org/feed.xml" title="OpenBazaar" /><script>
  (function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
  new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
  j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
  'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
  })(window,document,'script','dataLayer','GTM-P8J7H5F');
</script>

</head>
<body><!-- Google Tag Manager (noscript) -->
<noscript>
  <iframe src="https://www.googletagmanager.com/ns.html?id=GTM-P8J7H5F" height="0" width="0" style="display:none;visibility:hidden"></iframe>
</noscript>
<!-- End Google Tag Manager (noscript) -->
<header class="container">
    <nav class="navbar navbar-expand-lg navbar-light">
        <a class="navbar-brand" href="/">
            <img class="openbazaar-logo" alt="openbazaar logo" src="/assets/home/openbazaar-logo-316bbba492da4a2a44a7ad012f1054fdf0c47c1068d5a949f86bab5ab23a5980.png" integrity="sha256-MWu7pJLaSipEp60BLxBU/fDEfBBo1alJ+GurWrI6WYA=" crossorigin="anonymous">
        </a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-top" aria-controls="navbar-top"
            aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span> Menu
        </button>
        <div class="collapse navbar-collapse text-center text-lg-left" id="navbar-top">
            
            <ul class="navbar-nav ml-auto"><li class="nav-item ml-md-2 ">
                    <a class="nav-link" href="/features/">Features
                        
                    </a>
                </li>
                <li class="nav-item ml-md-2 ">
                    <a class="nav-link" href="/applications/">
                        Applications
                        
                    </a>
                </li>
                <li class="nav-item ml-md-2">
                    <a class="nav-link" href="https://docs.openbazaar.org/" target="_blank">API</a>
                </li>
                <li class="nav-item ml-md-2 ">
                    <a class="nav-link" href="/developers/">
                        Developers
                        
                    </a>
                </li>
                <li class="nav-item ml-md-2 ">
                    <a class="nav-link" href="/support/">
                        Support
                        
                    </a>
                </li>
                <li class="nav-item ml-md-2 active ">
                    <a class="nav-link" href="/blog/">
                        Blog
                        
                            <span class="sr-only">(current)</span>
                        
                    </a>
                </li>
                <li class="nav-item ml-md-2">
                    <a href="/mobile-updates/" class="button small download d-lg-none">Get It for Desktop</a>
                    <a href="/download/" class="button small download d-none d-lg-inline-flex">DOWNLOAD</a>
                </li>
            </ul>
        </div>
    </nav>
</header><main class="page-content" aria-label="Content">
      <div class="wrapper content">
        <article class="container limited">
    <div class="row">
        <div class="col-12">
            <section class="row pt-0 ">
    
        <div class="col-12 post-heading-image w-100 border-bottom">

        </div>
        <img class="post-openbazaar-logo mx-auto" alt="openbazaar-log0" src="/assets/blog/openbazaar-logo-9bc1d7020f444dc7e779cd01ca965d93105c47c54b6a58bd4d9df0592cf640f9.png" integrity="sha256-m8HXAg9ETcfnec0BypZdkxBcR8VLali9TZ3wWSz2QPk=" crossorigin="anonymous">
    
    <div class="col-12">
        <div class="row text-center mt-4">
            
                <div class="col"></div>
                <div class="col-8">
                    <a href="/blog/Escrow-Smart-Contract-Specification-in-OpenBazaar/">
                        <h3 class="post-title">
                            <span class='post-title-extra'>Escrow Smart Contract Specification</span> in OpenBazaar
                        </h3>
                    </a>
                </div>
                <div class="col"></div>
                <div class="col-12 d-flex justify-content-between my-4">
                    <div class="post-emojis">
                        <i class="fab fa-bitcoin post-icon-bitcoin"></i>
                        <img draggable="false" class="emoji medium post-emoji" alt="world emoji" src="https://s.w.org/images/core/emoji/2.4/svg/1f30e.svg">
                        <img draggable="false" class="emoji medium post-emoji" alt="‚úå" src="https://s.w.org/images/core/emoji/2.4/svg/270c.svg">
                    </div>
                    <a class="post-openbazaar-link" href="/">OpenBazaar.org</a>
                </div>
            
            <div class="col-12 post-date text-left mb-3">
                Oct 24, 2018
            </div>
            
                <div class="col-12 text-left post-container">
                    <p><em>By Austin Williams, OpenBazaar Researcher</em></p>

<p>The integration of Ethereum into OpenBazaar represents one of the most challenging and rewarding tasks we‚Äôve done for the project so far. We are so excited to bring our vision of seeing cryptocurrency and tokens used for real-world commerce to the Ethereum community!</p>

<blockquote class="twitter-tweet" data-lang="en"><p lang="en" dir="ltr">Welcome to the family! Look forward to seeing what you and openbazaar come up with</p>&mdash; Vitalik Non-giver of Ether (@VitalikButerin) <a href="https://twitter.com/VitalikButerin/status/987001278764118018?ref_src=twsrc%5Etfw">April 19, 2018</a></blockquote>
<script async="" src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>

<h3 id="introduction">Introduction</h3>

<p><a href="https://openbazaar.org">OpenBazaar</a> facilitates trades between arbitrary third parties on the internet. Currently, only UTXO-based cryptocurrencies can be used as a medium of exchange on OpenBazaar. The escrow contract is intended to be used as a way to shoehorn Ethereum functionality into OpenBazaar‚Äôs existing framework so that users can trade using ETH and ERC20 tokens as their medium of exchange.</p>

<h3 id="how-openbazaar-trades-currently-work-in-utxo-land">How OpenBazaar Trades Currently Work (in UTXO land)</h3>

<h4 id="moderated-payments">Moderated Payments</h4>

<p>When a buyer and seller have agreed on a product and a price, the buyer sends their funds to an escrow address, which is a 2-of-3 multisig address with one key controlled by the buyer, one key controlled by the seller, and one key controlled by a <a href="https://openbazaar.org/blog/how-to-choose-a-good-moderator-on-openbazaar">moderator</a> that has been agreed upon by both the buyer and the seller.</p>

<p>On the ‚Äúhappy path‚Äù, the seller delivers the goods, then the buyer releases the funds to the seller (with the buyer and seller signing the payout transaction from the escrow address).</p>

<p>In the event that the seller does not deliver the goods as promised, the buyer pleads their case to the moderator, and the buyer &amp; moderator can send the funds from escrow back to the buyer.</p>

<p>In the (very common) case where the buyer receives their goods but doesn‚Äôt release the funds to the seller, the seller presents their case to the moderator, and the seller &amp; moderator sign the funds from escrow to the seller.</p>

<p>The seller can also unilaterally release funds from escrow after a previously agreed upon amount of time has passed. This allows the seller to release the funds from escrow without the moderator in the event that the buyer disappears. With UTXO-based coins, this is achieved by requiring that the buyer sign an nLockTime transaction releasing funds to the seller, and then passing that transaction to the seller (off-chain) before the seller delivers the product or service.</p>

<h4 id="direct-payments">Direct Payments</h4>

<p>Buyers have the option of <em>not</em> using a moderator when making an OpenBazaar trade. While this isn‚Äôt recommended, it may be an acceptable risk for the buyer if the buyer trusts the seller. Direct or unmoderated payments come in two forms: online payments and offline payments.</p>

<p><strong>Online direct payments</strong> occur when the buyer knows the seller is online. For online payments, the buyer simply sends the funds directly to the seller‚Äôs wallet after requesting an address to pay to. These are simple, classic transfers of value from one account to another.</p>

<p><strong>Offline payments</strong> occur when the buyer sees that the seller is offline and is <em>uncertain</em> whether the seller will ever come back online. In this case the buyer sends the funds to a 1-of-2 multisig address with one key held by the buyer and the other held by the seller. If the seller comes back online, they can accept the funds. If the seller doesn‚Äôt come back online, the buyer can reclaim the funds.</p>

<p><strong>Limitations Imposed by OpenBazaar‚Äôs Wallet Interface</strong></p>

<p>OpenBazaar interacts with all supported coins through its <a href="https://github.com/OpenBazaar/wallet-interface/blob/master/wallet.go#L77">wallet interface</a>. This means that OpenBazaar‚Äôs Ethereum smart contracts must be designed in such a way as to be compatible with that interface. OpenBazaar is a live/launched product, so making big changes to the wallet interface in order to support Ethereum is non-trivial. Instead, we‚Äôve decided to keep the wallet interface fixed (for now), and design the smart contract to be compatible with it.</p>

<h3 id="intended-use-of-the-escrow-contract">Intended Use of the Escrow contract</h3>

<p>The Escrow contract will store the escrowed funds and state information for <em>every</em> OpenBazaar trade that is using Ethereum (or ERC20 tokens) as the medium of exchange.</p>

<p>We could have, instead, opted to deploy a new escrow contract for each Ethereum-based trade‚Ää‚Äî‚Ääthereby siloing escrowed funds from each trade in their own smart contract. However, we think the gas requirements for doing so are cost prohibitive, and we fear that would introduce too much friction into Ethereum-based trades.</p>

<p>OpenBazaar trades that use ETH/ERC20 as the medium of exchange are intended to follow the same protocol as those that use a UTXO-based coin as the medium of exchange‚Ää‚Äî‚Ääand the escrow smart contract is intended to facilitate that.</p>

<h4 id="funding-the-trade">Funding the Trade</h4>

<p>Buyers initiate a trade by creating/storing a <code class="highlighter-rouge">Transaction</code> struct in the Escrow contract and (simultaneously) funding the transaction by sending ETH (or ERC20 tokens) to the Escrow contract. At this point the transaction is in the <code class="highlighter-rouge">FUNDED</code> state. While in the <code class="highlighter-rouge">FUNDED</code> state, the buyer may add more ETH (or ERC20 tokens) to escrow if necessary.</p>

<h4 id="releasing-funds-from-escrow">Releasing Funds from Escrow</h4>

<p>While the transaction is in the <code class="highlighter-rouge">FUNDED</code> state, the escrowed funds can be released only if:</p>

<ol>
  <li>Two of the three participants (buyer, seller, and moderator) agree on how the escrowed funds are to be distributed.</li>
  <li>An amount of time (<code class="highlighter-rouge">timeoutHourse</code>) has passed since the last time the buyer added funds to escrow.</li>
</ol>

<p>The reasoning behind (2) is that it is very common for buyers to not release funds after they‚Äôve received their goods (this is due more to buyer laziness than malice). In that event, we want to make it easy for the seller to claim the escrowed funds without having to coordinate with a moderator.</p>

<p>Funds released from escrow can be split up and sent to various addresses. However, the receiving addresses <em>must be</em> the addresses of the trade‚Äôs buyer, seller, or moderator. To reiterate, funds cannot be sent to an address that is not affiliated with the trade in question, but the escrowed funds can be divided up among the participants in any way‚Ää‚Äî‚Ääso long as 2-of-3 of the parties agree.</p>

<p>Upon release of funds from escrow, the trade is put into the <code class="highlighter-rouge">RELEASED</code> state. Once in the <code class="highlighter-rouge">RELEASED</code> state, trades can no longer be altered. All participants who received some of the escrowed funds are noted in the trade‚Äôs Transaction struct (via the <code class="highlighter-rouge">beneficiaries</code> mapping).</p>

<p>(The <code class="highlighter-rouge">beneficiaries</code> information will be used later, by other contracts, to determine whether or not a given trade was disputed, refunded, etc.).</p>

<h4 id="offline-direct-payments">Offline Direct Payments</h4>

<p>The escrow contract can mirror the behavior of UTXO-based offline payments by calling <code class="highlighter-rouge">addTransaction</code> (or <code class="highlighter-rouge">addTokenTransaction</code> if it is an ERC20 transaction), setting the <code class="highlighter-rouge">threshold</code> value to 1, and setting the moderator address to a known, non-zero burn address. The effect is the equivalent of a 1-of-2 multisig address where the buyer holds one key and the seller holds the other.</p>

<h3 id="known-issues--misc">Known Issues / Misc</h3>

<h4 id="moderator-selection">Moderator selection</h4>

<p>It is assumed that the moderator is <em>trusted</em> by both the buyer and the seller before the trade begins. The obvious threat of collusion between a buyer and moderator‚Ää‚Äî‚Ääor seller and moderator‚Ää‚Äî‚Ääis beyond the scope of this contract.</p>

<h4 id="push-vs-pull">Push vs pull</h4>

<p>The <code class="highlighter-rouge">transferFunds</code> function uses push payments (rather than the pull model) due to limitations imposed by OpenBazaar‚Äôs wallet interface. Hence any of the beneficiaries of a payout from escrow can cause the payout to fail (for example, by putting a <code class="highlighter-rouge">revert()</code> in their fallback function).</p>

<p>Game theoretically speaking, such a DoS attack is irrational for any of the participants capable of causing such an issue, because the honest parties can always benefit by removing the offending party as a beneficiary and taking her share of the payout.</p>

<p>For example, suppose the three parties agreed that the moderator would received 5% of the funds, and that the buyer and seller would split the remaining funds. The seller, being unhappy with the result, could cause the payout to fail until she could negotiate a more favorable agreement. However, the buyer &amp; moderator‚Ää‚Äî‚Ääupon seeing the seller‚Äôs misbehavior‚Ää‚Äî‚Ääcould simply agree to remove the seller as a beneficiary‚Ää‚Äî‚Ääthus removing the seller‚Äôs ability to DoS the payout.)</p>

<p>For this reason, we consider the DoS possibility caused by use of push payments in the <code class="highlighter-rouge">transferFunds</code> function to be low risk.</p>

<h3 id="security">Security</h3>

<h4 id="quality-assurance">Quality assurance</h4>

<p>The code for the escrow smart contract can be found in Github <a href="https://github.com/OpenBazaar/smart-contracts/blob/master/contracts/escrow/Escrow_v1_0.sol">here</a>. We invite the community to examine the code and post issues or suggestions. Furthermore, we have written 37 tests for the contract to achieve &gt;90% code coverage.</p>

<h4 id="audit">Audit</h4>

<p>We‚Äôll be working with <a href="https://openzeppelin.org/">OpenZeppelin</a> to have the contracts audited and hope to have the audit process completed before the end of the year.</p>

<h3 id="special-thanks">Special thanks</h3>

<p>We‚Äôd like to extend a special thanks to the following folks who helped us get here:</p>

<ul>
  <li>Andrey ü¶É Petrov</li>
  <li>Ashwin Mangale</li>
  <li>Sameep Singhania</li>
  <li>Austin Williams</li>
  <li>Chris Pacia</li>
  <li><a href="https://openzeppelin.org/">OpenZeppelin</a></li>
</ul>

                </div>
            
        </div>
    </div>
</section>
        </div>
    </div>
</article>
<div class="container-fluid mb-5">
    <div class="row">
        <div class="col-12 pb-4">
            <hr class="help-us-separator">
            <div class="container limited">
                <p>
                    <strong>Do you want to help build this with us?</strong>
                </p>
                <p>
                    <a href="/download/" class="general-link" target="_blank">Download OpenBazaar</a> right now to start buying or selling in minutes or just see what's for sale at <a class="general-link" href="https://openbazaar.com" target="_blank">OpenBazaar.com</a>. 
                </p>
                <p>
                    Developers, join us on <a class="general-link" href="https://github.com/openbazaar" target="_blank">Github</a> to contribute to this open-source project!
                </p>
                <p>
                    <!-- AddToAny BEGIN -->
                    <div class="a2a_kit a2a_kit_size_32 a2a_default_style">
                        <a class="a2a_dd" href="https://www.addtoany.com/share"></a>
                        <a class="a2a_button_tumblr"></a>
                        <a class="a2a_button_facebook"></a>
                        <a class="a2a_button_twitter"></a>
                    </div>
                    <script async src="https://static.addtoany.com/menu/page.js"></script>
                    <!-- AddToAny END -->
                </p>
            </div>
        </div>
    </div>
    <div class="row recent-updates-wrapper border-bottom border-top">
    <div class="col-12">
        <section class="container">
            <div class="row">
                <div class="col-12 mb-4 emphasis-text">
                    <h3 class="recent-updates-heading">Recent updates</h3>
                </div>
                <div class="col-12">
                    <div class="card-deck text-center">
                        
                            <div class="card p-3 mb-4">
                                <div class="card-body d-flex flex-column justify-content-between">
                                    <a href="/blog/happy-holidays-from-ob1/">
                                        <h5 class="recent-updates-title">Happy Holidays from OB1 - Your Gifts Are Coming Soon</h5>
                                    </a>
                                    <div class="recent-updates-body mt-2">
                                        Happy holidays! The OB1 team is taking a bit of time off this week as 2018 comes to a close. We have been working hard on plans for 2019 and can‚Äôt wait to give you some gifts. ...
                                    </div>

                                    <a href="/blog/happy-holidays-from-ob1/" class="button small mt-4 mx-auto">read more</a>
                                </div>
                            </div>
                        
                            <div class="card p-3 mb-4">
                                <div class="card-body d-flex flex-column justify-content-between">
                                    <a href="/blog/what-you-really-need-to-know-about-the-dangers-of-deplatforming/">
                                        <h5 class="recent-updates-title">What You Really Need To Know About The Dangers Of Deplatforming</h5>
                                    </a>
                                    <div class="recent-updates-body mt-2">
                                        In the video below, OB1 Co-Founder Sam Patterson discusses recent increases in ‚Äúdeplatforming‚Äù by major online networks and service providers.


                                    </div>

                                    <a href="/blog/what-you-really-need-to-know-about-the-dangers-of-deplatforming/" class="button small mt-4 mx-auto">read more</a>
                                </div>
                            </div>
                        
                            <div class="card p-3 mb-4">
                                <div class="card-body d-flex flex-column justify-content-between">
                                    <a href="/blog/OpenBazaar-Developer-Call-December-13-2018/">
                                        <h5 class="recent-updates-title">OpenBazaar Developer Call - December 13, 2018</h5>
                                    </a>
                                    <div class="recent-updates-body mt-2">
                                        This is a video recording of the OpenBazaar Developer call on December 13, 2018.


                                    </div>

                                    <a href="/blog/OpenBazaar-Developer-Call-December-13-2018/" class="button small mt-4 mx-auto">read more</a>
                                </div>
                            </div>
                        
                            <div class="card p-3 mb-4">
                                <div class="card-body d-flex flex-column justify-content-between">
                                    <a href="/blog/how-openbazaar-bitcoin-could-kill-the-american-pickers-economy/">
                                        <h5 class="recent-updates-title">How OpenBazaar & Bitcoin Could Kill the American Pickers Economy</h5>
                                    </a>
                                    <div class="recent-updates-body mt-2">
                                        By Sam Patterson, OB1 Co-Founder


                                    </div>

                                    <a href="/blog/how-openbazaar-bitcoin-could-kill-the-american-pickers-economy/" class="button small mt-4 mx-auto">read more</a>
                                </div>
                            </div>
                        
                    </div>
                </div>
            </div>
        </section>
    </div>
</div>
</div>
      </div>
    </main><div class="container">
    <footer class="row pb-4">
        <div class="col-12 col-md-8">
            <nav class="navbar navbar-expand-sm navbar-light">
                <div class="collapse show navbar-collapse text-center text-sm-left" id="navbar-bottom">
                    <ul class="navbar-nav">
                        <li class="nav-item">
                            <a class="nav-link " href="/about/">About</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link " href="/events/">Events</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link " href="/newsletter/">Newsletter</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link " href="/contributors/">Contributors</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link " href="/bitcoin/">Need Bitcoin?</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link " href="/donate/">Donate</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link " href="/privacy/">Privacy</a>
                        </li>
                    </ul>
                </div>
            </nav>
        </div>
        <div class="col-12 col-md-4 d-flex flex-row justify-content-md-end justify-content-center">
            <a href="https://twitter.com/openbazaar">
                <i class="social-icon ml-2 fab fa-twitter d-flex align-items-center"></i>
            </a>
            <a href="/slack">
                <i class="social-icon ml-2 fab fa-slack-hash d-flex align-items-center"></i>
            </a>
            <a href="https://www.reddit.com/r/OpenBazaar/">
                <i class="social-icon ml-2 fab fa-reddit-alien d-flex align-items-center"></i>
            </a>
            <a href="https://github.com/openbazaar">
                <i class="social-icon ml-2 fab fa-github d-flex align-items-center"></i>
            </a>
            <a href="mailto:project@openbazaar.org" target="_top">
                <i class="social-icon ml-2 fas fa-envelope d-flex align-items-center"></i>
            </a>
        </div>
    </footer>
</div>
<script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
    <script src="/assets/app-ac637ccb876dfcbfc8f39a55a38191bc750e676f622196ba9dcf469b9e3b327e.js" integrity="sha256-rGN8y4dt/L/I85pVo4GRvHUOZ29iIZa6nc9Gm547Mn4=" crossorigin="anonymous" type="text/javascript"></script>
  </body>

</html>
